function initmblock(){var t=$("#REX_FORM"),i=$(".mblock_wrapper");t.length&&i.length&&initmblocksort(i)}function initsort(t){reindexit(t),initmblocksort(t)}function initmblocksort(t){addlinking(t),removeme(t),sortit(t)}function removeme(t){var i=t.find("> div");1==i.length?i.find(".removeme").prop("disabled",!0):i.find(".removeme").prop("disabled",!1),t.data().hasOwnProperty("max")&&(i.length>=t.data("max")?t.find(".addme").prop("disabled",!0):t.find(".addme").prop("disabled",!1)),t.data().hasOwnProperty("min")&&(i.length<=t.data("min")?t.find(".removeme").prop("disabled",!0):t.find(".removeme").prop("disabled",!1)),i.each(function(e){e+1==t.data("min")&&i.length==t.data("min")&&$(this).find(".removeme").prop("disabled",!0),0==e?$(this).find(".moveup").prop("disabled",!0):$(this).find(".moveup").prop("disabled",!1),e+1==i.length?$(this).find(".movedown").prop("disabled",!0):$(this).find(".movedown").prop("disabled",!1)})}function sortit(t){t.sortable({handle:".sorthandle",animation:150,onEnd:function(){reindexit(t)}})}function reindexit(t){removeme(t),t.find("> div").each(function(i){$(this).find("input,textarea,select").each(function(){var e=$(this).attr("name");if("undefined"!=typeof e&&e!==!1){var n=$(this).attr("name").replace($(this).attr("name").match(/\]\[\d+\]\[/g),"]["+i+"][");$(this).attr("name",n)}replacefor(t,$(this),i),"SELECT"==$(this).prop("nodeName")&&($(this).attr("id").indexOf("REX_MEDIALIST_SELECT_")>=0||$(this).attr("id").indexOf("REX_LINKLIST_SELECT_")>=0)&&($(this).attr("id",$(this).attr("id").replace(/\d+/,i)),void 0!=$(this).attr("name")&&$(this).attr("name",$(this).attr("name").replace(/\d+/,i))),"INPUT"==$(this).prop("nodeName")&&($(this).attr("id").indexOf("REX_LINK_")>=0||$(this).attr("id").indexOf("REX_LINKLIST_")>=0||$(this).attr("id").indexOf("REX_MEDIA_")>=0||$(this).attr("id").indexOf("REX_MEDIALIST_")>=0)&&($(this).attr("id",$(this).attr("id").replace(/\d+/,i)),$(this).parent().find("a.btn-popup").each(function(){$(this).attr("onclick",$(this).attr("onclick").replace(/\(\d+/,"("+i)),$(this).attr("onclick",$(this).attr("onclick").replace(/_\d+/,"_"+i))}))}),$(this).find(".redactor-box").each(function(){var t=$(this).find(".redactor-toolbar"),e=$(this).find(".redactor-voice-label"),n=$(this).find(".redactor-in");t.attr("id",t.attr("id").replace(/\d+/,i)),e.attr("id",e.attr("id").replace(/\d+/,i)),n.attr("id",n.attr("id").replace(/\d+/,i)),$(this).find("textarea").each(function(){$(this).attr("id")&&$(this).attr("id",$(this).attr("id").replace(/(.{1})\s*$/,i))})})})}function replacefor(t,i,e){i.attr("id").indexOf("REX_MEDIA")>=0||i.attr("id").indexOf("REX_LINK")>=0||i.attr("id").indexOf("redactor")>=0||(i.attr("id",i.attr("id").replace(/_\d_+/,"_"+e+"_")),i.parent().find("label").length&&(label=i.parent().find("label")),i.parent().parent().find("label").length&&(label=i.parent().parent().find("label")),label.length&&label.attr("for",label.attr("for").replace(/_\d_+/,"_"+e+"_"))),replacecheckboxfor(t)}function replacecheckboxfor(t){t.find("input:checkbox").each(function(){$(this).parent().find("label").attr("for",$(this).attr("id"))})}function additem(t,i){i.parent().hasClass(t.attr("class"))&&(t.sortable("destory"),i.after(i.clone()),t.data().hasOwnProperty("input_delete")&&1==t.data("input_delete")&&(i.next().find("input, textarea").val(""),i.next().find("option:selected").removeAttr("selected"),i.next().find("input:checked").removeAttr("checked"),i.next().find("select").each(function(){($(this).attr("id").indexOf("REX_MEDIALIST")>=0||$(this).attr("id").indexOf("REX_LINKLIST")>=0)&&$(this).find("option").remove()})),initsort(t))}function removeitem(t,i){i.parent().hasClass(t.attr("class"))&&(t.sortable("destory"),i.remove(),initsort(t))}function moveup(t,i){var e=i.prev();0!=e.length&&(e.css("z-index",99).addClass("mblock_animate").css({position:"relative",top:i.outerHeight(!0)}),i.css("z-index",100).addClass("mblock_animate").css({position:"relative",top:-e.outerHeight(!0)}),setTimeout(function(){e.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),i.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),i.insertBefore(e),reindexit(t)},150))}function movedown(t,i){var e=i.next();0!=e.length&&(e.css("z-index",99).addClass("mblock_animate").css({position:"relative",top:-i.outerHeight(!0)}),i.css("z-index",100).addClass("mblock_animate").css({position:"relative",top:e.outerHeight(!0)}),setTimeout(function(){e.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),i.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),i.insertAfter(e),reindexit(t)},150))}function addlinking(t){t.find("> div .addme").unbind().bind("click",function(){return $(this).prop("disabled")||additem(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .removeme").unbind().bind("click",function(){return $(this).prop("disabled")||removeitem(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .moveup").unbind().bind("click",function(){return $(this).prop("disabled")||moveup(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .movedown").unbind().bind("click",function(){return $(this).prop("disabled")||movedown(t,$(this).closest('div[class^="sortitem"]')),!1})}$(function(){initmblock(),$(document).on("pjax:end",function(){initmblock()})});