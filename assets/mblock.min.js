function mblock_init(){var t=$(".mblock_wrapper");$("#REX_FORM").length&&t.length&&t.each(function(){mblock_sort($(this))})}function mblock_init_sort(t){mblock_reindex(t),mblock_sort(t)}function mblock_sort(t){mblock_add(t),mblock_remove(t),mblock_sortable(t)}function mblock_remove(t){var e=t.find("> div");1==e.length?e.find(".removeme").prop("disabled",!0):e.find(".removeme").prop("disabled",!1),t.data().hasOwnProperty("max")&&(e.length>=t.data("max")?t.find(".addme").prop("disabled",!0):t.find(".addme").prop("disabled",!1)),t.data().hasOwnProperty("min")&&(e.length<=t.data("min")?t.find(".removeme").prop("disabled",!0):t.find(".removeme").prop("disabled",!1)),e.each(function(i){i+1==t.data("min")&&e.length==t.data("min")&&$(this).find(".removeme").prop("disabled",!0),0==i?$(this).find(".moveup").prop("disabled",!0):$(this).find(".moveup").prop("disabled",!1),i+1==e.length?$(this).find(".movedown").prop("disabled",!0):$(this).find(".movedown").prop("disabled",!1)})}function mblock_sortable(t){t.sortable({handle:".sorthandle",animation:150,onEnd:function(){mblock_reindex(t)}})}function mblock_reindex(t){mblock_remove(t);var e=!1,i=!1;t.find("> div").each(function(n){$(this).find("input,textarea,select").each(function(e){var i=$(this).attr("name");if(eindex=e+1,sindex=n+1,"undefined"!=typeof i&&i!==!1){var a=$(this).attr("name").replace($(this).attr("name").match(/\]\[\d+\]\[/g),"]["+n+"][");$(this).attr("name",a)}$(this).attr("id")&&mblock_replace_for(t,$(this),n),"SELECT"==$(this).prop("nodeName")&&($(this).attr("id").indexOf("REX_MEDIALIST_SELECT_")>=0||$(this).attr("id").indexOf("REX_LINKLIST_SELECT_")>=0)&&($(this).parent().data("eindex",eindex),$(this).attr("id",$(this).attr("id").replace(/_\d+/,"_"+sindex+"00"+eindex)),void 0!=$(this).attr("name")&&$(this).attr("name",$(this).attr("name").replace(/_\d+/,"_"+sindex+"00"+eindex))),"INPUT"==$(this).prop("nodeName")&&($(this).attr("id").indexOf("REX_LINK_")>=0||$(this).attr("id").indexOf("REX_LINKLIST_")>=0||$(this).attr("id").indexOf("REX_MEDIA_")>=0||$(this).attr("id").indexOf("REX_MEDIALIST_")>=0)&&($(this).parent().data("eindex")&&(eindex=$(this).parent().data("eindex")),$(this).attr("id",$(this).attr("id").replace(/\d+/,sindex+"00"+eindex)),$(this).parent().find("a.btn-popup").each(function(){$(this).attr("onclick",$(this).attr("onclick").replace(/\(\d+/,"("+sindex+"00"+eindex)),$(this).attr("onclick",$(this).attr("onclick").replace(/_\d+/,"_"+sindex+"00"+eindex))}))}),$(this).find(".redactor-box").each(function(t){e=!0,eindex=t+1,sindex=n+1,$(this).find("textarea").each(function(){$(this).attr("id")&&$(this).attr("id",$(this).attr("id").replace(/\d+/,sindex+"00"+eindex))})}),$(this).find(".markitup_markdown, .markitup_textile").each(function(t){i=!0,eindex=t+1,sindex=n+1,$(this).find("textarea").each(function(){$(this).attr("id")&&$(this).attr("id",$(this).attr("id").replace(/\d+/,sindex+"00"+eindex))})})}),e&&($(".redactor-box").each(function(){var t,e="";$(this).find("div.redactor-in").each(function(){$(this).attr("role")&&(e=$(this).html())}),$(this).find("textarea").each(function(){$(this).attr("id")&&(t=$(this).clone().css("display","block"))}),t.length&&($(this).parent().append(t),$(this).parent().find("textarea").val(e),$(this).remove())}),"function"==typeof redactorInit&&redactorInit()),i&&($(".markitup_markdown, .markitup_textile").each(function(){var t;$(this).find("textarea").each(function(){t=$(this).clone()}),t.length&&($(this).parent().append(t),$(this).remove())}),"function"==typeof markitupInit&&"function"==typeof autosize&&(markitupInit(),autosize($("textarea[class*='markitupEditor-']"))))}function mblock_replace_for(t,e,i){e.attr("id").indexOf("REX_MEDIA")>=0||e.attr("id").indexOf("REX_LINK")>=0||e.attr("id").indexOf("redactor")>=0||e.attr("id").indexOf("markitup")>=0||(e.attr("id",e.attr("id").replace(/_\d_+/,"_"+i+"_")),e.parent().find("label").length&&(label=e.parent().find("label")),e.parent().parent().find("label").length&&(label=e.parent().parent().find("label")),label.length&&label.attr("for",label.attr("for").replace(/_\d_+/,"_"+i+"_"))),mblock_replace_checkbox_for(t)}function mblock_replace_checkbox_for(t){t.find("input:checkbox").each(function(){$(this).parent().find("label").attr("for",$(this).attr("id"))})}function mblock_add_item(t,e){e.parent().hasClass(t.attr("class"))&&(t.sortable("destory"),e.after(e.clone()),t.data().hasOwnProperty("input_delete")&&1==t.data("input_delete")&&(e.next().find("div.redactor-in").html(""),e.next().find("input, textarea").val(""),e.next().find("textarea").html(""),e.next().find("option:selected").removeAttr("selected"),e.next().find("input:checked").removeAttr("checked"),e.next().find("select").each(function(){($(this).attr("id").indexOf("REX_MEDIALIST")>=0||$(this).attr("id").indexOf("REX_LINKLIST")>=0)&&$(this).find("option").remove()})),mblock_init_sort(t))}function mblock_remove_item(t,e){e.parent().hasClass(t.attr("class"))&&(t.sortable("destory"),e.remove(),mblock_init_sort(t))}function mblock_moveup(t,e){var i=e.prev();0!=i.length&&(i.css("z-index",99).addClass("mblock_animate").css({position:"relative",top:e.outerHeight(!0)}),e.css("z-index",100).addClass("mblock_animate").css({position:"relative",top:-i.outerHeight(!0)}),setTimeout(function(){i.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),e.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),e.insertBefore(i),mblock_reindex(t)},150))}function mblock_movedown(t,e){var i=e.next();0!=i.length&&(i.css("z-index",99).addClass("mblock_animate").css({position:"relative",top:-e.outerHeight(!0)}),e.css("z-index",100).addClass("mblock_animate").css({position:"relative",top:i.outerHeight(!0)}),setTimeout(function(){i.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),e.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),e.insertAfter(i),mblock_reindex(t)},150))}function mblock_add(t){t.find("> div .addme").unbind().bind("click",function(){return $(this).prop("disabled")||mblock_add_item(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .removeme").unbind().bind("click",function(){return $(this).prop("disabled")||mblock_remove_item(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .moveup").unbind().bind("click",function(){return $(this).prop("disabled")||mblock_moveup(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .movedown").unbind().bind("click",function(){return $(this).prop("disabled")||mblock_movedown(t,$(this).closest('div[class^="sortitem"]')),!1})}$(function(){mblock_init(),$(document).on("pjax:end",function(){mblock_init()})});