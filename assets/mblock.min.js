function initmblock(){var t=$("#REX_FORM"),e=$(".mblock_wrapper");t.length&&e.length&&initmblocksort(e)}function initsort(t){reindexit(t),initmblocksort(t)}function initmblocksort(t){addlinking(t),removeme(t),sortit(t)}function removeme(t){var e=t.find("> div");1==e.length?e.find(".removeme").addClass("mblock_hide"):e.find(".removeme").removeClass("mblock_hide"),t.data().hasOwnProperty("max")&&(e.length>=t.data("max")?t.find(".addme").addClass("mblock_hide"):t.find(".addme").removeClass("mblock_hide")),t.data().hasOwnProperty("min")&&(e.length<=t.data("min")?t.find(".removeme").addClass("mblock_hide"):t.find(".removeme").removeClass("mblock_hide")),e.each(function(i){i+1==t.data("min")&&e.length==t.data("min")&&$(this).find(".removeme").addClass("mblock_hide"),0==i?$(this).find(".moveup").addClass("mblock_hide"):$(this).find(".moveup").removeClass("mblock_hide"),i+1==e.length?$(this).find(".movedown").addClass("mblock_hide"):$(this).find(".movedown").removeClass("mblock_hide")})}function sortit(t){t.sortable({handle:".sorthandle",animation:150,onEnd:function(){reindexit(t)}})}function reindexit(t){removeme(t),t.find("> div").each(function(e){$(this).find("input,textarea,select").each(function(){var i=$(this).attr("name");if("undefined"!=typeof i&&i!==!1){var n=$(this).attr("name").replace($(this).attr("name").match(/\]\[\d+\]\[/g),"]["+e+"][");$(this).attr("name",n)}replacefor(t,$(this),e),"SELECT"==$(this).prop("nodeName")&&($(this).attr("id").indexOf("REX_MEDIALIST_SELECT_")>=0||$(this).attr("id").indexOf("REX_LINKLIST_SELECT_")>=0)&&($(this).attr("id",$(this).attr("id").replace(/\d+/,e)),void 0!=$(this).attr("name")&&$(this).attr("name",$(this).attr("name").replace(/\d+/,e))),"INPUT"==$(this).prop("nodeName")&&($(this).attr("id").indexOf("REX_LINK_")>=0||$(this).attr("id").indexOf("REX_LINKLIST_")>=0||$(this).attr("id").indexOf("REX_MEDIA_")>=0||$(this).attr("id").indexOf("REX_MEDIALIST_")>=0)&&($(this).attr("id",$(this).attr("id").replace(/\d+/,e)),$(this).parent().find("a.btn-popup").each(function(){$(this).attr("onclick",$(this).attr("onclick").replace(/\(\d+/,"("+e)),$(this).attr("onclick",$(this).attr("onclick").replace(/_\d+/,"_"+e))}))}),$(this).find(".redactor-box").each(function(){var t=$(this).find(".redactor-toolbar"),i=$(this).find(".redactor-voice-label"),n=$(this).find(".redactor-in");t.attr("id",t.attr("id").replace(/\d+/,e)),i.attr("id",i.attr("id").replace(/\d+/,e)),n.attr("id",n.attr("id").replace(/\d+/,e)),$(this).find("textarea").each(function(){$(this).attr("id")&&$(this).attr("id",$(this).attr("id").replace(/(.{1})\s*$/,e))})})})}function replacefor(t,e,i){e.attr("id").indexOf("REX_MEDIA")>=0||e.attr("id").indexOf("REX_LINK")>=0||e.attr("id").indexOf("redactor")>=0||(e.attr("id",e.attr("id").replace(/_\d_+/,"_"+i+"_")),e.parent().find("label").length&&(label=e.parent().find("label")),e.parent().parent().find("label").length&&(label=e.parent().parent().find("label")),label.length&&label.attr("for",label.attr("for").replace(/_\d_+/,"_"+i+"_"))),replacecheckboxfor(t)}function replacecheckboxfor(t){t.find("input:checkbox").each(function(){$(this).parent().find("label").attr("for",$(this).attr("id"))})}function additem(t,e){e.parent().hasClass(t.attr("class"))&&(t.sortable("destory"),e.after(e.clone()),t.data().hasOwnProperty("input_delete")&&1==t.data("input_delete")&&(e.next().find("input, textarea").val(""),e.next().find("option:selected").removeAttr("selected"),e.next().find("input:checked").removeAttr("checked"),e.next().find("select").each(function(){($(this).attr("id").indexOf("REX_MEDIALIST")>=0||$(this).attr("id").indexOf("REX_LINKLIST")>=0)&&$(this).find("option").remove()})),initsort(t))}function removeitem(t,e){e.parent().hasClass(t.attr("class"))&&(t.sortable("destory"),e.remove(),initsort(t))}function moveup(t,e){var i=e.prev();0!=i.length&&(i.css("z-index",99).addClass("mblock_animate").css({position:"relative",top:e.outerHeight(!0)}),e.css("z-index",100).addClass("mblock_animate").css({position:"relative",top:-i.outerHeight(!0)}),setTimeout(function(){i.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),e.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),e.insertBefore(i),reindexit(t)},150))}function movedown(t,e){var i=e.next();0!=i.length&&(i.css("z-index",99).addClass("mblock_animate").css({position:"relative",top:-e.outerHeight(!0)}),e.css("z-index",100).addClass("mblock_animate").css({position:"relative",top:i.outerHeight(!0)}),setTimeout(function(){i.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),e.removeClass("mblock_animate").css({"z-index":"",top:"",position:""}),e.insertAfter(i),reindexit(t)},150))}function addlinking(t){t.find("> div .addme").unbind().bind("click",function(){return $(this).hasClass("mblock_hide")||additem(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .removeme").unbind().bind("click",function(){return $(this).hasClass("mblock_hide")||removeitem(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .moveup").unbind().bind("click",function(){return $(this).hasClass("mblock_hide")||moveup(t,$(this).closest('div[class^="sortitem"]')),!1}),t.find("> div .movedown").unbind().bind("click",function(){return $(this).hasClass("mblock_hide")||movedown(t,$(this).closest('div[class^="sortitem"]')),!1})}$(function(){initmblock(),$(document).on("pjax:end",function(){initmblock()})});